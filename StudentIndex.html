<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Students</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey:            "AIzaSyApuSW1IjB5U_9nDuV67ZlPJ8_C8fTOQVk",
      authDomain:        "aeroclubwebsiteapp.firebaseapp.com",
      projectId:         "aeroclubwebsiteapp",
      storageBucket:     "aeroclubwebsiteapp.appspot.com",
      messagingSenderId: "529559179400",
      appId:             "1:529559179400:web:cd1ca2c64a3efcb0970f3d",
      measurementId:     "G-X69J831LCJ"
    };
    // Initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Redirect if not logged in
    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = 'index.html';
    });
  </script>
</head>
<body>
  <div class="container">

    <!-- NAVIGATION -->
    <nav>
  <ul>
    <li><a href="home.html">Home</a></li>
    <li><a href="StudentIndex.html">Students</a></li>
    <li><a href="instructors.html">Instructors</a></li>
    <li><a href="flights.html">Flights</a></li>
    <li><a href="aircraft.html">Aircraft</a></li>
    <li id="adminNav" style="display:none;"><a href="admin.html">Admin Panel</a></li>
  </ul>
</nav>


    <!-- HEADER -->
    <div class="header card">
      <h2>Students</h2>
      <button id="openModalBtn">+ Add Student</button>
    </div>

    <!-- STUDENT GRID -->
    <div id="studentList"></div>
  </div>

  <!-- Add Student Modal -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <button id="closeModalBtn" class="close-btn">&times;</button>
      <h3>Add Student</h3>
      <form id="studentForm">
        <input name="name"        placeholder="Full Name" required>
        <input name="membership"  placeholder="Membership #" required>
        <select name="sex" required>
          <option value="">Select Sex</option><option>Male</option><option>Female</option>
        </select>
        <input  name="email"       type="email" placeholder="Student Email" required>
        <input  name="phone"       type="tel"   placeholder="Phone Number" required>
        <input  name="dob"         type="date"  placeholder="Date of Birth" required>
        <textarea name="dietary"      placeholder="Dietary Requirements"></textarea>
        <textarea name="medication"   placeholder="Medication Details"></textarea>
        <textarea name="disabilities" placeholder="Disabilities"></textarea>
        <textarea name="address"      placeholder="Address"></textarea>
        <button type="submit">Save Student</button>
      </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button id="closeProfileBtn" class="close-btn">&times;</button>
      <h3>Student Profile</h3>
      <div id="profileContent"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const openBtn    = document.getElementById('openModalBtn');
      const closeBtn   = document.getElementById('closeModalBtn');
      const modal      = document.getElementById('studentModal');
      const form       = document.getElementById('studentForm');
      const list       = document.getElementById('studentList');
      const pModal     = document.getElementById('profileModal');
      const closeProf  = document.getElementById('closeProfileBtn');
      const pContent   = document.getElementById('profileContent');

      // Fetch & render students from Firestore
      function fetchStudents() {
        db.collection('students')
          .orderBy('name')
          .get()
          .then(snapshot => {
            const students = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            render(students);
          });
      }

      // Calculate age
      function calculateAge(dob) {
        const diffMs = Date.now() - new Date(dob).getTime();
        return Math.abs(new Date(diffMs).getUTCFullYear() - 1970);
      }

      // Render grid
      function render(students) {
        list.innerHTML = '';
        students.forEach((s,idx) => {
          const card = document.createElement('div');
          card.className = 'student-card';
          card.innerHTML = `
            <button class="delete-btn" data-id="${s.id}">&times;</button>
            <h3 data-id="${s.id}" class="name-cell">${s.name}</h3>
            <p>${s.membership}</p>
          `;
          list.appendChild(card);
        });
        attachListeners(students);
      }

      // Wire up click handlers
      function attachListeners(students) {
        // Delete
        list.querySelectorAll('.delete-btn').forEach(btn => {
          btn.onclick = () => {
            db.collection('students').doc(btn.dataset.id)
              .delete().then(fetchStudents);
          };
        });
        // Profile
        list.querySelectorAll('.name-cell').forEach(h3 => {
          h3.onclick = () => showProfile(h3.dataset.id, students);
        });
      }

      // Show profile
      function showProfile(id, students) {
        const s = students.find(x => x.id === id);
        pContent.innerHTML = `
          <p><strong>Name:</strong> ${s.name}</p>
          <p><strong>Membership #:</strong> ${s.membership}</p>
          <p><strong>Sex:</strong> ${s.sex}</p>
          <p><strong>Email:</strong> ${s.email}</p>
          <p><strong>Phone:</strong> ${s.phone}</p>
          <p><strong>DOB:</strong> ${s.dob}</p>
          <p><strong>Age:</strong> ${s.age} years</p>
          <p><strong>Dietary:</strong> ${s.dietary || 'N/A'}</p>
          <p><strong>Medication:</strong> ${s.medication || 'N/A'}</p>
          <p><strong>Disabilities:</strong> ${s.disabilities || 'N/A'}</p>
          <p><strong>Address:</strong> ${s.address || 'N/A'}</p>
        `;
        pModal.classList.add('active');
      }

      // Modal controls
      openBtn.onclick = () => modal.classList.add('active');
      closeBtn.onclick = () => { modal.classList.remove('active'); form.reset(); };
      modal.onclick = e => { if (e.target===modal) { modal.classList.remove('active'); form.reset(); } };
      closeProf.onclick = () => pModal.classList.remove('active');
      pModal.onclick = e => { if (e.target===pModal) pModal.classList.remove('active'); };

      // Add student
      form.addEventListener('submit', e => {
        e.preventDefault();
        const data = new FormData(form);
        const student = {
          name:         data.get('name'),
          membership:   data.get('membership'),
          sex:          data.get('sex'),
          email:        data.get('email'),
          phone:        data.get('phone'),
          dob:          data.get('dob'),
          age:          calculateAge(data.get('dob')),
          dietary:      data.get('dietary'),
          medication:   data.get('medication'),
          disabilities: data.get('disabilities'),
          address:      data.get('address')
        };
        db.collection('students')
          .add(student)
          .then(() => {
            form.reset();
            modal.classList.remove('active');
            fetchStudents();
          });
      });

      // Initial load
      fetchStudents();
    });
  </script>
</body>
</html>
