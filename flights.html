<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flights</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      apiKey:            "AIzaSyApuSW1IjB5U_9nDuV67ZlPJ8_C8fTOQVk",
      authDomain:        "aeroclubwebsiteapp.firebaseapp.com",
      projectId:         "aeroclubwebsiteapp",
      storageBucket:     "aeroclubwebsiteapp.appspot.com",
      messagingSenderId: "529559179400",
      appId:             "1:529559179400:web:cd1ca2c64a3efcb0970f3d",
      measurementId:     "G-X69J831LCJ"
    };
    firebase.initializeApp(firebaseConfig);

    // 2) Force LOCAL persistence so onAuthStateChanged fires with the cached user
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .catch(err => console.error("Auth persistence error:", err));

    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>
</head>
<body>
  <div class="container">
    <!-- NAVIGATION -->
    <nav>
      <ul>
        <li><a href="home.html">Home</a></li>
        <li><a href="StudentIndex.html">Students</a></li>
        <li><a href="instructors.html">Instructors</a></li>
        <li><a href="flights.html" class="active">Flights</a></li>
        <li><a href="aircraft.html">Aircraft</a></li>
        <li id="adminNav" style="display:none;"><a href="admin.html">Admin Panel</a></li>
      </ul>
    </nav>

    <div class="header card">
      <h2>Flight Entries</h2>
      <button id="addFlightBtn">+ Add Flight</button>
    </div>

    <table id="flightsTable" class="card">
      <thead>
        <tr>
          <th>FAF Number</th><th>Date</th><th>Student</th><th>Membership#</th>
          <th>Rego</th><th>Flight Details</th><th>PIC</th>
          <th>VDO Start</th><th>VDO Stop</th><th>Hours</th>
          <th>Landings</th><th>Full Stops</th><th>Cost ($)</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Add Flight Modal -->
  <div id="flightModal" class="modal">
    <div class="modal-content">
      <button id="closeFlightModal" class="close-btn">&times;</button>
      <h3>Add Flight Entry</h3>
      <form id="flightForm">
        <input name="faf"        type="text"   placeholder="FAF Number" required>
        <input name="date"       type="date"   required>
        <select name="student"   required>
          <option value="">Select Student</option>
        </select>
        <input name="membership" type="text"   placeholder="Membership #" readonly>
        <select name="aircraft"  required>
          <option value="">Select Aircraft</option>
        </select>
        <select name="lesson"    required>
          <option value="">Select Lesson Type</option>
          <!-- all lesson options here -->
        </select>
        <select name="pic" required>
          <option value="">Select PIC</option>
        </select>
        <!-- DECIMAL support -->
        <input name="vdoStart" type="number" step="0.01" placeholder="VDO Start" required>
        <input name="vdoStop"  type="number" step="0.01" placeholder="VDO Stop"  required>
        <input name="hours"    type="number" step="0.01" placeholder="Hours Flown" readonly>
        <input name="landings" type="number" step="1"    placeholder="Total Landings" required>
        <input name="fullStops"type="number" step="1"    placeholder="Full Stops"    required>
        <input name="cost"     type="number" step="0.01" placeholder="Flight Cost ($)" required>
        <button type="submit">Save Flight</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM refs
      const addBtn      = document.getElementById('addFlightBtn');
      const modal       = document.getElementById('flightModal');
      const closeBtn    = document.getElementById('closeFlightModal');
      const form        = document.getElementById('flightForm');
      const tbody       = document.querySelector('#flightsTable tbody');
      const studentSel  = form.student;
      const memberIn    = form.membership;
      const aircraftSel = form.aircraft;
      const picSel      = form.pic;
      const vdoStart    = form.vdoStart;
      const vdoStop     = form.vdoStop;
      const hoursIn     = form.hours;
      const costIn      = form.cost;

      let students = [], instructors = [], aircrafts = [];

      // Populate dropdowns
      function loadRefs() {
        db.collection('students').orderBy('name').get().then(snap => {
          students = snap.docs.map(d=>({id:d.id,...d.data()}));
          studentSel.innerHTML = '<option value="">Select Student</option>' +
            students.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        });
        db.collection('instructors').orderBy('name').get().then(snap => {
          instructors = snap.docs.map(d=>({id:d.id,...d.data()}));
          picSel.innerHTML = '<option value="">Select PIC</option>' +
            instructors.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
        });
        db.collection('aircrafts').orderBy('reg').get().then(snap => {
          aircrafts = snap.docs.map(d=>({id:d.id,...d.data()}));
          aircraftSel.innerHTML = '<option value="">Select Aircraft</option>' +
            aircrafts.map(a=>`<option value="${a.id}">${a.reg}</option>`).join('');
        });
      }

      // Calculate & round hours/cost
      function recalc() {
        const vs = parseFloat(vdoStart.value)||0;
        const ve = parseFloat(vdoStop.value)||0;
        const hrs = Math.max(0, ve - vs);
        hoursIn.value = hrs.toFixed(2);

        const ac = aircrafts.find(a=>a.id===aircraftSel.value);
        const rate = ac ? ac.cost : 0;
        const fs   = parseInt(form.fullStops.value)||0;
        const tot  = hrs * rate + fs * 35;
        costIn.value = tot.toFixed(2);
      }

      // Render flight list
      function renderFlights(list) {
        tbody.innerHTML = '';
        list.forEach(f => {
          const tr = document.createElement('tr');
          const st = students.find(s=>s.id===f.student)||{};
          const ac = aircrafts.find(a=>a.id===f.aircraft)||{};
          const pi = instructors.find(i=>i.id===f.pic)||{};
          tr.innerHTML = `
            <td>${f.faf}</td>
            <td>${f.date}</td>
            <td>${st.name||''}</td>
            <td>${st.membership||''}</td>
            <td>${ac.reg||''}</td>
            <td>${f.lesson}</td>
            <td>${pi.name||''}</td>
            <td>${f.vdoStart}</td>
            <td>${f.vdoStop}</td>
            <td>${f.hours}</td>
            <td>${f.landings}</td>
            <td>${f.fullStops}</td>
            <td>${f.cost}</td>
            <td><button class="delete-btn" data-id="${f.id}">&times;</button></td>
          `;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('.delete-btn').forEach(b => {
          b.onclick = () => db.collection('flights').doc(b.dataset.id)
                            .delete().then(fetchFlights);
        });
      }

      // Fetch flights
      function fetchFlights() {
        db.collection('flights').orderBy('date','desc').get().then(snap => {
          const arr = snap.docs.map(d=>({id:d.id,...d.data()}));
          renderFlights(arr);
        });
      }

      // Modal controls
      addBtn.onclick = () => {
        modal.classList.add('active');
        form.date.value = new Date().toISOString().split('T')[0];
      };
      closeBtn.onclick = () => {
        modal.classList.remove('active');
        form.reset(); hoursIn.value=''; costIn.value='';
      };
      modal.onclick = e => {
        if (e.target === modal) {
          modal.classList.remove('active');
          form.reset(); hoursIn.value=''; costIn.value='';
        }
      };

      // Auto-fill membership & recalc
      studentSel.onchange = () => {
        const s = students.find(s=>s.id===studentSel.value);
        memberIn.value = s? s.membership : '';
      };
      [vdoStart, vdoStop, form.fullStops, aircraftSel].forEach(el=> el.oninput = recalc);

      // Handle save
      form.addEventListener('submit', e => {
        e.preventDefault();
        const d = new FormData(form);
        const entry = {
          faf:       d.get('faf'),
          date:      d.get('date'),
          student:   d.get('student'),
          aircraft:  d.get('aircraft'),
          lesson:    d.get('lesson'),
          pic:       d.get('pic'),
          vdoStart:  parseFloat(d.get('vdoStart')),
          vdoStop:   parseFloat(d.get('vdoStop')),
          hours:     parseFloat(d.get('hours')),
          landings:  parseInt(d.get('landings')),
          fullStops: parseInt(d.get('fullStops')),
          cost:      parseFloat(d.get('cost'))
        };
        db.collection('flights').add(entry)
          .then(() => {
            form.reset(); hoursIn.value=''; costIn.value='';
            modal.classList.remove('active');
            fetchFlights();
          })
          .catch(err => console.error("Save error:", err));
      });

      // Only after auth do we kick off
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'index.html';
          return;
        }
        // show admin link?
        db.collection('roles').doc(user.uid).get().then(doc => {
          document.getElementById('adminNav').style.display =
            (doc.exists && doc.data().admin) ? 'inline-block' : 'none';
        });
        loadRefs();
        fetchFlights();
      });
    });
  </script>
</body>
</html>
